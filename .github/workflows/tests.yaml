name: Tests

on:
  pull_request:
    branches:
    - main

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: DeterminateSystems/nix-installer-action@main
    - uses: DeterminateSystems/magic-nix-cache-action@main
    - uses: nicknovitski/nix-develop@v1
    - run: terraform version
    - uses: haythem/public-ip@v1.3
      id: ip
    - run: terraform init
      env:
        TF_VAR_ip: ${{ steps.ip.outputs.ipv4 }}
    - name: 'Cache Terraform'
      uses: actions/cache@v3
      with:
        path: .terraform
        key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
        restore-keys: ${{ runner.os }}-terraform-
    - run: terraform validate
      env:
        TF_VAR_ip: ${{ steps.ip.outputs.ipv4 }}

  tflint:
    name: 'TFLint'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: terraform-linters/setup-tflint@v4
      with:
        tflint_version: latest
    - run: tflint --version
    - run: tflint --init
    - run: tflint -f compact

  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ludeeus/action-shellcheck@master

  validate-commit-message:
    name: Validate Commit Message
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.LIMITED_GITHUB_TOKEN }}
