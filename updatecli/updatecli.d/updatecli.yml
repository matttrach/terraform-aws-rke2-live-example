# This small test makes sure that updatecli is working properly on a repo.
# To test this:
#   have "UPDATECLI_GITHUB_ACTOR" env set to your github username
#   have "UPDATECLI_GITHUB_TOKEN" env set to your github token
#   have "UPDATECLI_GITHUB_OWNER" env set to your github repo's group
#   have the latest version of updatecli installed
#   'updatecli diff -v updatecli/values.yaml -c updatecli/updatecli.d/updatecli.yml'
# In the future, more useful files should be added to this directory.
# Common gotcha: check to make sure the default branches are correct
# Token Permissions: the token needs "contents" read and write, "issues" read and write, and "pull requests" read and write.
---
name: "Introduce updatecli to repo and validate basic functionality"
# Make sure we can pull in github repos from multiple orgs
scms:
  this-repo:
    kind: "github"
    spec:
      user: "{{ requiredEnv .github.user }}"
      email: "{{ requiredEnv .github.email }}"
      owner: "{{ requiredEnv .github.owner }}"
      repository: live-infra-aws-rke2
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: main
  go-repo:
    kind: "github"
    spec:
      user: "{{ requiredEnv .github.user }}"
      email: "{{ requiredEnv .github.email }}"
      owner: golang
      repository: go
      token: '{{ requiredEnv .github.token }}'
      username: "{{ requiredEnv .github.username }}"
      branch: master
sources:
  # validate gittag parsing external public repos
  goTag:
    name: "Get Go 1.20.2 tag"
    kind: "gittag"
    scmid: "go-repo"
    spec:
      versionfilter:
        kind: "regex"
        pattern: '^go1\.20\.2$'

# Validate read access to local repo
## continue to targets if the go version in the validate file doesn't match the goTag source
conditions:
  testVersionShouldMatchGoTag:
    name:
    kind: yaml
    sourceid: goTag
    spec:
      file: "updatecli/validate.yml"
      key: "$.version"
    failwhen: true #if set to true, continue to targets when condition is true rather than false

# Validate the ability to generate branches, commits, what the commits look like, and what branches look like
## allow validation of workflow to delete unused branch after merge
## generate a commit on a branch named updatecli_<256 sha of change>
## the commit message will be automatically generated by updatecli based on the change
targets:
  updateValidateFile:
    name: "Update the version in the validate file"
    kind: "yaml"
    scmid: "this-repo"
    sourceid: goTag
    spec:
      file: "updatecli/validate.yml"
      key: "$.version"

# Validate generating a pull request
actions:
  # create a pull request which is not allowed to automerge
  # the title matches the commit message
  github:
    kind: "github/pullrequest"
    scmid: "this-repo"
    spec:
      automerge: false
      draft: false
      mergemethod: squash
      parent: false # this would allow for making a PR to an upstream fork, if we ran updatecli from a fork